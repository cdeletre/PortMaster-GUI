#!/bin/bash

# TODO: check this
CUR_TTY=/dev/tty0

directory="userdata/roms"

ESUDO=""
ESUDOKILL="-1" # for 351Elec and EmuELEC use "-1" (numeric one) or "-k" 

# Install our own shGenerator.py
if ! grep 'gamecontrollerdb.txt' /usr/lib/python3.11/site-packages/configgen/generators/sh/shGenerator.py; then
  cp -f /usr/lib/python3.11/site-packages/configgen/generators/sh/shGenerator.py /usr/lib/python3.11/site-packages/configgen/generators/sh/shGenerator.py.bak

  if ! grep 'from generators.Generator import Generator' /usr/lib/python3.11/site-packages/configgen/generators/sh/shGenerator.py; then
    # New style relative imports
    cp -f $controlfolder/batocera/shGenerator.py /usr/lib/python3.11/site-packages/configgen/generators/sh/shGenerator.py
  else
    # Old style absolute imports
    cp -f $controlfolder/knulli/shGenerator.py /usr/lib/python3.11/site-packages/configgen/generators/sh/shGenerator.py
  fi

  batocera-save-overlay
fi

if [ -f "$HOME/.config/gamecontrollerdb.txt" ]; then
  export SDL_GAMECONTROLLERCONFIG_FILE="$HOME/.config/gamecontrollerdb.txt"
elif [ -f "/tmp/gamecontrollerdb.txt" ]; then
  export SDL_GAMECONTROLLERCONFIG_FILE="/tmp/gamecontrollerdb.txt"
else
  export SDL_GAMECONTROLLERCONFIG_FILE="/$controlfolder/knulli/gamecontrollerdb.txt"
fi

SDLDBFILE="${SDL_GAMECONTROLLERCONFIG_FILE}"
SDLDBUSERFILE="${HOME}/.config/SDL-GameControllerDB/gamecontrollerdb.txt"
[[ ! -f "${SDLDBUSERFILE}" ]] && SDLDBUSERFILE="$SDL_GAMECONTROLLERCONFIG_FILE"

get_controls() {
  # TODO: figure out SDL_GAMECONTROLLERCONFIG
  ANALOGSTICKS="${ANALOG_STICKS:-2}"
  LOWRES="N"

  export SDL_GAMECONTROLLERCONFIG_FILE="/tmp/gamecontrollerdb.txt"

  # Call pm_swapabxy when enabled
  [[ -f "$HOME/.pm_swapabxy" ]] && pm_swapabxy && export SDL_GAMECONTROLLERCONFIG="$(< "${SDL_GAMECONTROLLERCONFIG_FILE}")"

  sdl_controllerconfig="$(< "${SDL_GAMECONTROLLERCONFIG_FILE}")"
    
}

pm_swapabxy() {
  # Kdog abxy swap function
  # sed recipe from Nevrdid with minor fix by Kdog
  # https://discord.com/channels/1122861252088172575/1284167323330154606/1284190354857525248

  gamecontrollerdb_pm="/tmp/gamecontrollerdb_pm.txt"

  sed -E 's/(,[ab]:)([^,]+)(.*)(,[ba]:)([^,]+)/\1\5\3\4\2/; s/(,[xy]:)([^,]+)(.*)(,[yx]:)([^,]+)/\1\5\3\4\2/' "$SDL_GAMECONTROLLERCONFIG_FILE" > "$gamecontrollerdb_pm"

  # Deploy only if the resulting file has at least one entry
  n_entries=`grep ",platform:" "$gamecontrollerdb_pm" | wc -l | cut -d' ' -f1`
  [[ $? -eq 0 && $n_entries -gt 0 ]] && export SDL_GAMECONTROLLERCONFIG_FILE="$gamecontrollerdb_pm"

}

source $controlfolder/device_info.txt
source $controlfolder/funcs.txt

GPTOKEYB2="$ESUDO env LD_PRELOAD=$controlfolder/libinterpose.${DEVICE_ARCH}.so $controlfolder/gptokeyb2 $ESUDOKILL"
GPTOKEYB="$ESUDO $controlfolder/gptokeyb $ESUDOKILL"